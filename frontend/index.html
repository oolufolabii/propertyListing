<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property Listings | MartinDoksHomes</title>
  
  <!-- TailwindCSS -->
  <script src="https://cdn.twind.style" crossorigin></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Custom Styles -->
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #e74c3c;
      --accent-color: #3498db;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-color);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background-color: #1a252f;
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-secondary:hover {
      background-color: #c0392b;
    }
    
    .property-card {
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }
    
    .property-card:hover {
      transform: translateY(-5px);
    }
    
    .property-image {
      height: 200px;
      background-size: cover;
      background-position: center;
    }
    
    .property-badge {
      background-color: var(--secondary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .whatsapp-btn {
      background-color: #25D366;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s;
    }
    
    .whatsapp-btn:hover {
      background-color: #128C7E;
    }
    
    .header {
      background-color: var(--primary-color);
      color: white;
    }
    
    .footer {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Loading spinner */
    .loader {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--secondary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Property detail page */
    .property-detail-image {
      height: 400px;
      background-size: cover;
      background-position: center;
    }
    
    .thumbnail {
      width: 80px;
      height: 60px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .thumbnail.active {
      border-color: var(--secondary-color);
    }
  </style>
  
  <!-- Error Catching -->
  <script src="https://esm.town/v/std/catch"></script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="header py-4">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center">
        <a href="/" class="text-2xl font-bold">MartinDoksHomes</a>
        <nav>
          <ul class="flex space-x-6">
            <li><a href="/" class="hover:text-gray-300">Home</a></li>
            <li><a href="/#properties" class="hover:text-gray-300">Properties</a></li>
            <li><a href="/admin" class="hover:text-gray-300">Admin</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow">
    <!-- App will be mounted here -->
    <div id="app" class="container mx-auto px-4 py-8">
      <div class="flex justify-center items-center h-64">
        <div class="loader"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer py-6">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4">MartinDoksHomes</h3>
          <p class="mb-4">Your trusted partner in finding the perfect property.</p>
          <div class="flex space-x-4">
            <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-white hover:text-gray-300"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Quick Links</h3>
          <ul class="space-y-2">
            <li><a href="/" class="hover:text-gray-300">Home</a></li>
            <li><a href="/#properties" class="hover:text-gray-300">Properties</a></li>
            <li><a href="/admin" class="hover:text-gray-300">Admin</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4">Contact Us</h3>
          <p class="mb-2"><i class="fas fa-phone mr-2"></i> +234 913 969 4471</p>
          <p class="mb-2"><i class="fas fa-envelope mr-2"></i> info@martindokshomes.com</p>
          <p><i class="fas fa-map-marker-alt mr-2"></i> Lagos, Nigeria</p>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-6 text-center">
        <p>&copy; 2023 MartinDoksHomes. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- App Script -->
  <script type="module">
    // Constants
    const API_BASE_URL = '/api';
    const WHATSAPP_NUMBER = '+2349139694471';
    
    // DOM Elements
    const app = document.getElementById('app');
    
    // Helper Functions
    function formatPrice(price) {
      return new Intl.NumberFormat('en-NG', {
        style: 'currency',
        currency: 'NGN',
        maximumFractionDigits: 0
      }).format(price);
    }
    
    function getCategoryLabel(category) {
      const labels = {
        'sale': 'For Sale',
        'rent': 'For Rent',
        'lease': 'For Lease',
        'land': 'Land',
        'commercial': 'Commercial'
      };
      return labels[category] || category;
    }
    
    function getWhatsAppLink(property) {
      const message = `Hello, I'm interested in the property: ${property.title} (${getCategoryLabel(property.category)}) at ${property.location} for ${formatPrice(property.price)}. Can you provide more information?`;
      return `https://wa.me/${WHATSAPP_NUMBER.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
    }
    
    // Page Renderers
    async function renderHomePage() {
      try {
        // Fetch featured properties
        const response = await fetch(`${API_BASE_URL}/properties/search?featured=true`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch properties');
        }
        
        const properties = result.data || [];
        
        // Render home page
        app.innerHTML = `
          <!-- Hero Section -->
          <section class="bg-gray-100 py-16 mb-12">
            <div class="container mx-auto px-4">
              <div class="max-w-3xl mx-auto text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-6">Find Your Dream Property</h1>
                <p class="text-lg mb-8">Browse our selection of properties for sale, rent, lease, and more.</p>
                <a href="#properties" class="btn-primary">View Properties</a>
              </div>
            </div>
          </section>
          
          <!-- Search Section -->
          <section class="mb-12">
            <div class="container mx-auto px-4">
              <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Search Properties</h2>
                <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1">Category</label>
                    <select id="category" class="w-full p-2 border rounded">
                      <option value="">All Categories</option>
                      <option value="sale">For Sale</option>
                      <option value="rent">For Rent</option>
                      <option value="lease">For Lease</option>
                      <option value="land">Land</option>
                      <option value="commercial">Commercial</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Min Price</label>
                    <input type="number" id="min-price" class="w-full p-2 border rounded" placeholder="Min Price">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Max Price</label>
                    <input type="number" id="max-price" class="w-full p-2 border rounded" placeholder="Max Price">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">Location</label>
                    <input type="text" id="location" class="w-full p-2 border rounded" placeholder="Location">
                  </div>
                  <div class="md:col-span-4 flex justify-end">
                    <button type="submit" class="btn-primary">Search</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
          
          <!-- Featured Properties Section -->
          <section class="mb-12">
            <div class="container mx-auto px-4">
              <h2 class="text-3xl font-bold mb-8">Featured Properties</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${properties.length > 0 ? properties.map(property => `
                  <div class="property-card">
                    <div class="property-image" style="background-image: url('${property.images && property.images.length > 0 ? property.images[0].image_url : 'https://via.placeholder.com/400x300?text=No+Image'}')"></div>
                    <div class="p-4">
                      <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold">${property.title}</h3>
                        <span class="property-badge">${getCategoryLabel(property.category)}</span>
                      </div>
                      <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${property.location}</p>
                      <p class="text-2xl font-bold text-secondary-color mb-4">${formatPrice(property.price)}</p>
                      <div class="flex justify-between items-center">
                        <div class="flex space-x-4">
                          ${property.bedrooms ? `<span><i class="fas fa-bed mr-1"></i> ${property.bedrooms} Beds</span>` : ''}
                          ${property.bathrooms ? `<span><i class="fas fa-bath mr-1"></i> ${property.bathrooms} Baths</span>` : ''}
                          ${property.area ? `<span><i class="fas fa-vector-square mr-1"></i> ${property.area} m²</span>` : ''}
                        </div>
                        <a href="/property/${property.id}" class="text-accent-color hover:underline">View Details</a>
                      </div>
                    </div>
                  </div>
                `).join('') : `
                  <div class="col-span-3 text-center py-12">
                    <p class="text-xl text-gray-500">No featured properties available.</p>
                  </div>
                `}
              </div>
              <div class="text-center mt-8">
                <a href="#properties" class="btn-primary">View All Properties</a>
              </div>
            </div>
          </section>
          
          <!-- All Properties Section -->
          <section id="properties" class="mb-12">
            <div class="container mx-auto px-4">
              <h2 class="text-3xl font-bold mb-8">All Properties</h2>
              <div id="properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-3 flex justify-center">
                  <div class="loader"></div>
                </div>
              </div>
            </div>
          </section>
        `;
        
        // Load all properties
        loadAllProperties();
        
        // Add event listener for search form
        document.getElementById('search-form').addEventListener('submit', handleSearch);
      } catch (error) {
        console.error('Error rendering home page:', error);
        app.innerHTML = `
          <div class="text-center py-12">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Error</h2>
            <p class="mb-4">${error.message || 'Failed to load properties'}</p>
            <button onclick="location.reload()" class="btn-primary">Try Again</button>
          </div>
        `;
      }
    }
    
    async function loadAllProperties() {
      try {
        const propertiesGrid = document.getElementById('properties-grid');
        
        // Fetch all properties with images
        const response = await fetch(`${API_BASE_URL}/properties/with-images`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch properties');
        }
        
        const properties = result.data || [];
        
        // Render properties
        propertiesGrid.innerHTML = properties.length > 0 ? properties.map(property => `
          <div class="property-card">
            <div class="property-image" style="background-image: url('${property.images && property.images.length > 0 ? property.images[0].image_url : 'https://via.placeholder.com/400x300?text=No+Image'}')"></div>
            <div class="p-4">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-xl font-bold">${property.title}</h3>
                <span class="property-badge">${getCategoryLabel(property.category)}</span>
              </div>
              <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${property.location}</p>
              <p class="text-2xl font-bold text-secondary-color mb-4">${formatPrice(property.price)}</p>
              <div class="flex justify-between items-center">
                <div class="flex space-x-4">
                  ${property.bedrooms ? `<span><i class="fas fa-bed mr-1"></i> ${property.bedrooms} Beds</span>` : ''}
                  ${property.bathrooms ? `<span><i class="fas fa-bath mr-1"></i> ${property.bathrooms} Baths</span>` : ''}
                  ${property.area ? `<span><i class="fas fa-vector-square mr-1"></i> ${property.area} m²</span>` : ''}
                </div>
                <a href="/property/${property.id}" class="text-accent-color hover:underline">View Details</a>
              </div>
            </div>
          </div>
        `).join('') : `
          <div class="col-span-3 text-center py-12">
            <p class="text-xl text-gray-500">No properties available.</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading all properties:', error);
        const propertiesGrid = document.getElementById('properties-grid');
        propertiesGrid.innerHTML = `
          <div class="col-span-3 text-center py-12">
            <p class="text-xl text-red-600">Failed to load properties. Please try again later.</p>
          </div>
        `;
      }
    }
    
    async function handleSearch(event) {
      event.preventDefault();
      
      const category = document.getElementById('category').value;
      const minPrice = document.getElementById('min-price').value;
      const maxPrice = document.getElementById('max-price').value;
      const location = document.getElementById('location').value;
      
      try {
        const propertiesGrid = document.getElementById('properties-grid');
        propertiesGrid.innerHTML = `
          <div class="col-span-3 flex justify-center">
            <div class="loader"></div>
          </div>
        `;
        
        // Build query string
        let queryParams = [];
        if (category) queryParams.push(`category=${category}`);
        if (minPrice) queryParams.push(`minPrice=${minPrice}`);
        if (maxPrice) queryParams.push(`maxPrice=${maxPrice}`);
        if (location) queryParams.push(`location=${location}`);
        
        const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
        
        // Fetch filtered properties
        const response = await fetch(`${API_BASE_URL}/properties/search${queryString}`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to search properties');
        }
        
        const properties = result.data || [];
        
        // Render filtered properties
        propertiesGrid.innerHTML = properties.length > 0 ? properties.map(property => `
          <div class="property-card">
            <div class="property-image" style="background-image: url('${property.images && property.images.length > 0 ? property.images[0].image_url : 'https://via.placeholder.com/400x300?text=No+Image'}')"></div>
            <div class="p-4">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-xl font-bold">${property.title}</h3>
                <span class="property-badge">${getCategoryLabel(property.category)}</span>
              </div>
              <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${property.location}</p>
              <p class="text-2xl font-bold text-secondary-color mb-4">${formatPrice(property.price)}</p>
              <div class="flex justify-between items-center">
                <div class="flex space-x-4">
                  ${property.bedrooms ? `<span><i class="fas fa-bed mr-1"></i> ${property.bedrooms} Beds</span>` : ''}
                  ${property.bathrooms ? `<span><i class="fas fa-bath mr-1"></i> ${property.bathrooms} Baths</span>` : ''}
                  ${property.area ? `<span><i class="fas fa-vector-square mr-1"></i> ${property.area} m²</span>` : ''}
                </div>
                <a href="/property/${property.id}" class="text-accent-color hover:underline">View Details</a>
              </div>
            </div>
          </div>
        `).join('') : `
          <div class="col-span-3 text-center py-12">
            <p class="text-xl text-gray-500">No properties found matching your criteria.</p>
          </div>
        `;
      } catch (error) {
        console.error('Error searching properties:', error);
        const propertiesGrid = document.getElementById('properties-grid');
        propertiesGrid.innerHTML = `
          <div class="col-span-3 text-center py-12">
            <p class="text-xl text-red-600">Failed to search properties. Please try again later.</p>
          </div>
        `;
      }
    }
    
    async function renderPropertyDetailPage(propertyId) {
      try {
        // Fetch property details
        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}/with-images`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch property details');
        }
        
        const property = result.data;
        
        if (!property) {
          throw new Error('Property not found');
        }
        
        // Get primary image or first image
        const primaryImage = property.images.find(img => img.is_primary) || 
                            (property.images.length > 0 ? property.images[0] : null);
        
        // Render property detail page
        app.innerHTML = `
          <div class="mb-8">
            <a href="/" class="inline-flex items-center text-accent-color hover:underline">
              <i class="fas fa-arrow-left mr-2"></i> Back to Properties
            </a>
          </div>
          
          <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="property-detail-image" id="main-image" style="background-image: url('${primaryImage ? primaryImage.image_url : 'https://via.placeholder.com/800x600?text=No+Image'}')"></div>
            
            ${property.images.length > 1 ? `
              <div class="p-4 bg-gray-100 flex space-x-2 overflow-x-auto">
                ${property.images.map((image, index) => `
                  <div class="thumbnail ${primaryImage && primaryImage.id === image.id ? 'active' : ''}" 
                       style="background-image: url('${image.image_url}')"
                       data-image="${image.image_url}"
                       onclick="document.getElementById('main-image').style.backgroundImage = 'url(${image.image_url})'; 
                                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active')); 
                                this.classList.add('active')"></div>
                `).join('')}
              </div>
            ` : ''}
            
            <div class="p-6">
              <div class="flex justify-between items-start mb-4">
                <h1 class="text-3xl font-bold">${property.title}</h1>
                <span class="property-badge">${getCategoryLabel(property.category)}</span>
              </div>
              
              <p class="text-gray-600 mb-4"><i class="fas fa-map-marker-alt mr-2"></i> ${property.location}</p>
              
              <p class="text-3xl font-bold text-secondary-color mb-6">${formatPrice(property.price)}</p>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                ${property.bedrooms ? `
                  <div class="text-center p-3 bg-gray-100 rounded">
                    <i class="fas fa-bed text-2xl mb-2"></i>
                    <p>${property.bedrooms} Bedrooms</p>
                  </div>
                ` : ''}
                
                ${property.bathrooms ? `
                  <div class="text-center p-3 bg-gray-100 rounded">
                    <i class="fas fa-bath text-2xl mb-2"></i>
                    <p>${property.bathrooms} Bathrooms</p>
                  </div>
                ` : ''}
                
                ${property.area ? `
                  <div class="text-center p-3 bg-gray-100 rounded">
                    <i class="fas fa-vector-square text-2xl mb-2"></i>
                    <p>${property.area} m²</p>
                  </div>
                ` : ''}
              </div>
              
              <div class="mb-6">
                <h2 class="text-xl font-bold mb-2">Description</h2>
                <p class="text-gray-700 whitespace-pre-line">${property.description}</p>
              </div>
              
              <div class="flex justify-center">
                <a href="${getWhatsAppLink(property)}" target="_blank" class="whatsapp-btn">
                  <i class="fab fa-whatsapp"></i> Contact via WhatsApp
                </a>
              </div>
            </div>
          </div>
          
          <!-- Similar Properties Section -->
          <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6">Similar Properties</h2>
            <div id="similar-properties" class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="col-span-3 flex justify-center">
                <div class="loader"></div>
              </div>
            </div>
          </div>
        `;
        
        // Load similar properties
        loadSimilarProperties(property.category, property.id);
      } catch (error) {
        console.error('Error rendering property detail page:', error);
        app.innerHTML = `
          <div class="text-center py-12">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Error</h2>
            <p class="mb-4">${error.message || 'Failed to load property details'}</p>
            <a href="/" class="btn-primary">Back to Home</a>
          </div>
        `;
      }
    }
    
    async function loadSimilarProperties(category, currentPropertyId) {
      try {
        const similarPropertiesContainer = document.getElementById('similar-properties');
        
        // Fetch properties in the same category
        const response = await fetch(`${API_BASE_URL}/properties/category/${category}`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch similar properties');
        }
        
        // Filter out current property and limit to 3
        const similarProperties = result.data
          .filter(property => property.id !== currentPropertyId)
          .slice(0, 3);
        
        // Render similar properties
        similarPropertiesContainer.innerHTML = similarProperties.length > 0 ? similarProperties.map(property => `
          <div class="property-card">
            <div class="property-image" style="background-image: url('${property.images && property.images.length > 0 ? property.images[0].image_url : 'https://via.placeholder.com/400x300?text=No+Image'}')"></div>
            <div class="p-4">
              <h3 class="text-lg font-bold mb-2">${property.title}</h3>
              <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-1"></i> ${property.location}</p>
              <p class="text-xl font-bold text-secondary-color mb-3">${formatPrice(property.price)}</p>
              <a href="/property/${property.id}" class="text-accent-color hover:underline">View Details</a>
            </div>
          </div>
        `).join('') : `
          <div class="col-span-3 text-center py-6">
            <p class="text-gray-500">No similar properties found.</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading similar properties:', error);
        const similarPropertiesContainer = document.getElementById('similar-properties');
        similarPropertiesContainer.innerHTML = `
          <div class="col-span-3 text-center py-6">
            <p class="text-red-600">Failed to load similar properties.</p>
          </div>
        `;
      }
    }
    
    // Router
    function handleRouteChange() {
      const path = window.location.pathname;
      
      if (path === '/') {
        renderHomePage();
      } else if (path.startsWith('/property/')) {
        const propertyId = parseInt(path.split('/')[2]);
        if (!isNaN(propertyId)) {
          renderPropertyDetailPage(propertyId);
        } else {
          window.location.href = '/';
        }
      }
    }
    
    // Initialize the app
    handleRouteChange();
    
    // Handle browser navigation
    window.addEventListener('popstate', handleRouteChange);
  </script>
</body>
</html>
